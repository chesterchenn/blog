---
layout: post
tags: 2021 react
title: é«˜é˜¶ç»„ä»¶HOC
---

é«˜é˜¶ç»„ä»¶ HOC æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªç»„ä»¶å¹¶è¿”å›ä¸€ä¸ªæ–°ç»„ä»¶ã€‚æ™®é€šç»„ä»¶æ˜¯å°† props è½¬æ¢æˆ UIï¼Œè€Œé«˜é˜¶ç»„ä»¶å°†ç»„ä»¶è½¬æ¢æˆå¦ä¸€ä¸ªç»„ä»¶ã€‚

```jsx
const EnhancedComponent = higherOrderComponent(WrappedComponent);
```

<!-- vim-markdown-toc GFM -->

- [ä½¿ç”¨åŸå› å’Œå®ç°](#ä½¿ç”¨åŸå› å’Œå®ç°)
- [å±æ€§ä»£ç†](#å±æ€§ä»£ç†)
- [å®ä¾‹åº”ç”¨ - é¡µé¢å¤ç”¨](#å®ä¾‹åº”ç”¨---é¡µé¢å¤ç”¨)
- [å®ä¾‹åº”ç”¨ - æƒé™æ§åˆ¶](#å®ä¾‹åº”ç”¨---æƒé™æ§åˆ¶)
- [å®ä¾‹åº”ç”¨ - ç±»ç»„ä»¶ä½¿ç”¨ Hooks](#å®ä¾‹åº”ç”¨---ç±»ç»„ä»¶ä½¿ç”¨-hooks)
- [ä¸è¦æ”¹å˜åŸå§‹ç»„ä»¶ï¼Œä½¿ç”¨ç»„åˆ](#ä¸è¦æ”¹å˜åŸå§‹ç»„ä»¶ä½¿ç”¨ç»„åˆ)
- [ä¸‰ä¸ªçº¦å®š](#ä¸‰ä¸ªçº¦å®š)
- [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)
- [å‚è€ƒé“¾æ¥](#å‚è€ƒé“¾æ¥)

<!-- vim-markdown-toc -->

## ä½¿ç”¨åŸå› å’Œå®ç°

é«˜é˜¶ç»„ä»¶ä¸»è¦å¯ä»¥å¸®å¿™è§£å†³ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢çš„é—®é¢˜ï¼š

1. æŠ½å–é‡å¤ä»£ç ï¼Œå®ç°ç»„ä»¶å¤ç”¨ã€‚å¦‚é¡µé¢å¤ç”¨ã€‚
2. æ¡ä»¶æ¸²æŸ“ï¼Œæ§åˆ¶ç»„ä»¶çš„æ¸²æŸ“é€»è¾‘ï¼ˆæ¸²æŸ“åŠ«æŒï¼‰ã€‚å¦‚æƒé™æ§åˆ¶ã€‚
3. æ•è·/åŠ«æŒè¢«å¤„ç†ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚å¦‚ç»„ä»¶æ¸²æŸ“æ€§èƒ½è·Ÿè¸ªï¼Œæ—¥å¿—æ‰“ç‚¹ã€‚

ä¸»è¦å®ç°æœ‰ä¸¤ç§æ–¹å¼

1. å±æ€§ä»£ç†ï¼ˆProps Proxyï¼‰
2. åå‘ç»§æ‰¿ï¼ˆInheritance Inversionï¼‰

## å±æ€§ä»£ç†

å±æ€§ä»£ç†æœ¬è´¨æ˜¯ä½¿ç”¨ç»„åˆçš„æ–¹å¼ï¼Œé€šè¿‡å°†ç»„ä»¶åŒ…è£…åœ¨å®¹å™¨ç»„ä»¶ä¸­å®ç°åŠŸèƒ½ã€‚

```jsx
// è¿”å›ä¸€ä¸ªå‡½æ•°ç»„ä»¶
function hoc(WrappedComponent) {
  const newProps = { type: 'HOC' };
  return (props) => <WrappedComponent {...props} {...newProps} />;
}

// è¿”å›ä¸€ä¸ªç±»ç»„ä»¶
function hoc(WrappedComponent) {
  return class extends React.Component {
    render() {
      const newProps = { type: 'HOC' };
      return <WrappedComponent {...this.props} {...newProps} />;
    }
  };
}
```

ä»£ç ç¤ºä¾‹ï¼š[codesandbox](https://codesandbox.io/s/nostalgic-liskov-d2km9y?file=/src/App.js)

## å®ä¾‹åº”ç”¨ - é¡µé¢å¤ç”¨

æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆCross-Cutting Concernï¼‰ï¼Œå³ç³»ç»Ÿä¸­çš„éƒ¨åˆ†åŠŸèƒ½åœ¨å¤šä¸ªæ¨¡å—ä¸­å‡ºç°ã€‚æ‰€è°“æ¨ªåˆ‡å…³æ³¨ç‚¹å°±æ˜¯é¡µé¢å¤ç”¨ã€‚

å‡è®¾æœ‰ä¸€ä¸ª CommentList è¯„è®ºåˆ—è¡¨ç»„ä»¶å’Œä¸€ä¸ª BlogPost åšå®¢å¸–å­ç»„ä»¶ã€‚CommentList ç»„ä»¶è®¢é˜…å¤–éƒ¨æ•°æ®æºï¼Œç”¨ä»¥æ¸²æŸ“è¯„è®ºåˆ—è¡¨ã€‚BlogPost è®¢é˜…å•ä¸ªåšå®¢å¸–å­ï¼Œç”¨ä»¥æ¸²æŸ“åšå®¢ã€‚

å¯¹äºç»å¸¸å¤ç”¨çš„é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡ŒæŠ½è±¡ï¼Œåœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰è¿™ä¸ªé€»è¾‘ï¼Œå¹¶ä¸”åœ¨è®¸å¤šç»„ä»¶ä¹‹é—´å…±äº«å®ƒã€‚å¯¹äºä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªåˆ›å»ºç»„ä»¶çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†æ¥å—ä¸€ä¸ªå­ç»„ä»¶ä½œä¸ºå®ƒçš„å…¶ä¸­ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å­ç»„ä»¶å°†è®¢é˜…æ•°æ®ä½œä¸º propã€‚æˆ‘ä»¬å®šä¹‰å‡½æ•° withSubscription

ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¢«åŒ…è£…çš„ç»„ä»¶ã€‚ç¬¬äºŒä¸ªå‚æ•°é€šè¿‡ DataSource å’Œå½“å‰çš„ props è¿”å›æˆ‘ä»¬éœ€è¦çš„æ•°æ®ã€‚

```jsx
import DataSource from '..';
// hoc
function withSubscription(WrappedComponent, selectData) {
  return (props) => {
    const [data, setData] = useState(selectData(DataSource, props));

    function handlechange() {
      setData(selectdata(Datasource, props));
    }

    useEffect(() => {
      Datasource.addchangelistener(handlechange);
      return () => {
        Datasource.removechangelistener(handlechange);
      };
    }, []);

    return <wrappedcomponent data={data} {...props} />;
  };
}

const Commentlistwithsubscription = withsubscription(Commentlist, (datasource) =>
  Datasource.getcomments(),
);

const BlogPostWithSubscrption = withSubscription(BlogPost, (DataSource, props) =>
  DataSource.getBlogPost(props.id),
);
```

## å®ä¾‹åº”ç”¨ - æƒé™æ§åˆ¶

æƒé™æ§åˆ¶å…¶å®å°±æ˜¯åˆ©ç”¨é«˜é˜¶ç»„ä»¶çš„æ¡ä»¶æ¸²æŸ“æ¥æ§åˆ¶æ¸²æŸ“çš„ç»„ä»¶ã€‚

```jsx
function authWrapper(WrappedComponent) {
  // é€šè¿‡å…¶ä»–æ–¹æ³•è·¯å¾„è·å–æƒé™
  const isAuth = getAuth();
  if (!isAuth) return null;
  return (props) => <WrappedComponent {...props} />;
}
```

## å®ä¾‹åº”ç”¨ - ç±»ç»„ä»¶ä½¿ç”¨ Hooks

åœ¨æœ‰ç»§æ‰¿çš„æˆ–è€…éƒ¨åˆ†å¤æ‚çš„ç±»ç»„ä»¶ï¼Œéœ€è¦ä½¿ç”¨ hooks æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ HOC æ¥åŒ…è£¹æˆå‡½æ•°ç»„ä»¶ã€‚

```tsx
// App.tsx
import useName from './useName';

class Greeting extends React.Component<{ name: string }> {
  render() {
    return (
      <h1>
        Hello <span>{this.props.name}</span>
      </h1>
    );
  }
}

const WrapperGreeting = () => {
  const [name] = useName('chen');
  return <Greeting name={name} />;
};

export default function App() {
  return (
    <div className="App">
      <WrapperGreeting />
    </div>
  );
}
```

```ts
// useName.ts
import { useEffect, useState } from 'react';

const useName = (n: string) => {
  const [name, setName] = useState('');
  useEffect(() => {
    setName(n);
  }, [n]);
  return [name];
};

export default useName;
```

[https://codesandbox.io/s/class-component-use-hooks-cgmoo1](https://codesandbox.io/s/class-component-use-hooks-cgmoo1)

## ä¸è¦æ”¹å˜åŸå§‹ç»„ä»¶ï¼Œä½¿ç”¨ç»„åˆ

ä¸è¦åœ¨ HOC ä¸­ä¿®æ”¹ç»„ä»¶åŸå‹ï¼Œè¿™æ ·å­ä¼šäº§ç”Ÿä¸€äº›ä¸è‰¯åæœï¼ŒHOC ä¸åº”è¯¥ä¿®æ”¹ä¼ å…¥çš„ç»„ä»¶ï¼Œè€Œåº”è¯¥ä½¿ç”¨ç»„åˆçš„æ–¹å¼ï¼Œé€šè¿‡å°†ç»„ä»¶åŒ…è£…åœ¨å®¹å™¨ç»„ä»¶ä¸­å®ç°åŠŸèƒ½

```jsx
// é”™è¯¯çš„ä½¿ç”¨æ–¹å¼
function logPrpos(InputComponent) {
  InputComponent.prototype.componentDidUpdate = function (prevProps) {
    console.log('Current props: ', this.props);
    console.log('Previous props: ', prevProps);
  };
  // è¿”å›åŸå§‹çš„ input ç»„ä»¶ï¼Œæš—ç¤ºå®ƒå·²ç»è¢«ä¿®æ”¹ã€‚
  return InputComponent;
}

// æ¯æ¬¡è°ƒç”¨ logPrpos æ—¶ï¼Œå¢å¼ºç»„ä»¶éƒ½ä¼šæœ‰ log è¾“å‡º
const EnhancedComponent = logPrpos(InputComponent);
```

```jsx
// ä½¿ç”¨ç»„åˆçš„æ–¹å¼
function logProps(WrappedComponent) {
  return class extends React.Component {
    componentDidUpdate(prevProps) {
      console.log('Current props: ', this.props);
      console.log('Previous props: ', prevProps);
    }
    render() {
      // å°† input ç»„ä»¶åŒ…è£…åœ¨å®¹å™¨ä¸­ï¼Œè€Œä¸å¯¹å…¶è¿›è¡Œä¿®æ”¹
      return <WrappedComponent {...this.props} />;
    }
  };
}
```

## ä¸‰ä¸ªçº¦å®š

- çº¦å®šï¼šå°†ä¸ç›¸å…³çš„ props ä¼ é€’ç»™è¢«åŒ…è£¹çš„ç»„ä»¶

  è¿™ä¸ªçº¦å®šä¿è¯äº† HOC çš„çµæ´»æ€§ä»¥åŠå¯å¤ç”¨æ€§ã€‚HOC ä¸ºç»„ä»¶æ·»åŠ ç‰¹æ€§ï¼ŒHOC åº”è¯¥é€ä¼ ä¸è‡ªèº«æ— å…³çš„ propsã€‚å¤§å¤šæ•° HOC éƒ½åº”è¯¥åŒ…å«ç±»ä¼¼ä¸‹é¢çš„ render æ–¹æ³•

  ```jsx
  render() {
    // è¿‡æ»¤æ‰éæ­¤ HOC ä¸”é¢å¤–ä¸è¦è¿›è¡Œé€ä¼ çš„ props
    const { extraProp, ...passThroughProps } = this.props;

    // å°† props æ³¨å…¥åˆ°è¢«åŒ…è£…çš„ç»„ä»¶ä¸­ã€‚
    // é€šå¸¸ä¸º state çš„å€¼æˆ–è€…å®ä¾‹æ–¹æ³•ã€‚
    const injectedProps = someStateOrInstanceMethod;

    // å°† props ä¼ é€’ç»™è¢«åŒ…è£¹çš„ç»„ä»¶
    return (
      <wrappedcomponent injectedProps={injectedProps} {...passThroughProps} />
    );
  }
  ```

- çº¦å®šï¼šæœ€å¤§åŒ–å¯ç»„åˆæ€§

- çº¦å®šï¼šåŒ…è£…æ˜¾ç¤ºåç§°ä»¥ä¾¿è½»æ¾è°ƒè¯•

## æ³¨æ„äº‹é¡¹

- ä¸è¦åœ¨ render æ–¹æ³•ä¸­ä½¿ç”¨ HOC

- åŠ¡å¿…å¤åˆ¶é™æ€æ–¹æ³•

- Refs ä¸ä¼šè¢«ä¼ é€’

## å‚è€ƒé“¾æ¥

- [Reactjs: higher-order component](https://reactjs.org/docs/higher-order-components.html)
- [zhihu: é¢å‘å¯¹è±¡å›°å¢ƒä¹‹ â€”â€” æ¨ªåˆ‡å…³æ³¨ç‚¹](https://zhuanlan.zhihu.com/p/76618283)
- [React é«˜é˜¶ç»„ä»¶(HOC)çš„å…¥é—¨ ğŸ“– åŠå®è·µ ğŸ’» - æ˜é‡‘](https://juejin.cn/post/6844904050236850184)
