---
layout: post
tags: 2022 react
title: 阅读图解React笔记7
---

本文仅仅是阅读 [图解 React 原理系列](https://7kms.github.io/react-illustration-series/) 的笔记，了解更多内容请查看原文链接。

Fiber 树渲染

## Fiber 树特点

fiber 树的基本特点

- 无论是首次构造或者是对比更新，最终都会在内存中生成一棵用于渲染页面的 fiber 树，即 fiberRoot.finishedWork
- 这个将要被渲染的 fiber 树有 2 个特点：
  - 副作用队列挂载在根节点上，具体来说是 finishedWork.firstEffect
  - 代表最新页面的 DOM 对象挂载在 fiber 树中首个 HostComponent 类型的节点上，具体来讲 DOM 对象是挂载在 fiber.stateNode 属性上

## CommitRoot

整个渲染逻辑都在 CommitRoot 函数上，其源码位置 _react-reconciler/src/ReactFiberWorkLoop.new.js_

```js
function commitRoot(root) {
  const renderPriorityLevel = getCurrentPriorityLevel();
  runWithPriority(
    ImmediateSchedulerPriority,
    commitRootImpl.bind(null, root, renderPriorityLevel)
  );
  return null;
}
```

在 commitRoot 中同时使用到了渲染优先级和调度优先级，最后的实现是通过 commitRootImpl 函数：

```js
function commitRootImpl(root, renderPriorityLevel) {
  // ============
  // 渲染前准备
  // ============

  const finishedWork = root.finishedWork;
  const lanes = root.finishedLanes;

  // 清空 FiberRoot 对象上的属性
  root.finishedWork = null;
  root.finishedLanes = NoLanes;
  root.callbackNode = null;

  if (root === workInProgressRoot) {
    workInProgressRoot = null;
    workInProgress = null;
    workInProgressRootRenderLanes = NoLanes;
  }

  // ======
  // 渲染
  // ======

  // 检查是否有副作用在整个树
  const subtreeHasEffect =
    (finishedWork.subtreeFlags &
      (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==
    NoFlags;
  const rootHasEffect =
    (finishedWork.flags &
      (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==
    NoFlags;

  if (subtreeHasEffect || rootHasEffect) {
    const prevExecutionContext = executionContext;
    executionContext |= CommitContext;
    const prevInteractions = pushInteractions(root);

    // 调用生命周期前，重置为null
    ReactCurrentOwner.current = null;
  }
}
```

## 参考链接

- [github: react-illustration-series](https://github.com/7kms/react-illustration-series)
- [github: react](https://github.com/facebook/react)
- [图解 React: Fiber 树渲染](https://7kms.github.io/react-illustration-series/main/fibertree-commit/)
