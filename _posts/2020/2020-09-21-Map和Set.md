---
title: Map和Set
tags: javascript
---

Map 和 Set 是 ES6 中新增的数据结构，Map 类似于对象，但可以使用对象或者 map 值作为键值。Set 类似于数组，但是其中的值是唯一的。 

## Map
在 JavaScript 中，对象是创建无序键/值对数据结构[也称映射（map）]的主要机制。但是，对象作为映射的主要缺点是不能使用非字符串值作为键。如下：
```js
var m = {};
var x = { id: 1 }, y = { id : 2};
m[x] = "foo";
m[y] = "bar";

m[x]; // "bar"
m[y]; // "bar"
m;    // "[object Object]": "bar"
```
因为 x 和 y 两个对象作为键值（属性值）的时候，都被转化成字符串“[object Object]”，实际上在 m 中只设置了一个键值。


```js
var m = new Map();
var x = { id: 1 }, y = { id : 2};
m.set(x, "foo");
m.set(y, "bar");

m.get(x); // "foo"
m.get(y); // "bar"
m.delete(y);
m.size; // 1
m.clear();
```

可以使用 `var vals = [...m.values()];` 方式获取列值，使用 `var keys = [...m.keys()];` 获取键，使用 `m.has(x);` 判断是否有给定的键。

除非某些或者全部键是对象，这种情况下 map 更合适，否则继续使用普通对象作为影射更合适。

## WeakMap
WeakMap 是 map 的变体，区别在于内部内存分配（特别是垃圾回收）的工作方式。  

在 map 中如果使用对象作为映射的键，这个对象后来被丢弃（所有的引用解除），试图让垃圾回收（GC）回收其内存，那么 map 本身仍会保持其项目。你需要从 map 中移除这个项目来支持 GC。  

WeakMap 只接受对象作为键。这些对象是被弱持有，也就是说如果对象本身被垃圾回收的话，在 WeakMap 中的这个项目也会被移除。  

WeakMap 没有 size 属性或 clear() 方法。 

## Set
set 是一个值的集合，其中的值是唯一。  

set 的 API 跟 map 类似，add(..) 方法代替了 set(..) 方法，没有 get(..) 方法。

```js
var s = new Set();
var x = { id: 1 }, y = { id: 2 };

s.add(x);
s.add(y);
s.add(x);

s.size; // 2
s.has(y); // true
s.delete(y);
s.clear();
```

set 的唯一性可以用作一些地方：
```js
var arr = [1, 2, 3, 4, "1", 2, 4, "5"];
var uniques = [...new Set(arr)]; // [ 1, 2, 3, 4, "1", "5" ]
``` 

## WeakSet
WeakSet 的值必须是对象，而不是像 set 一样可以是原生类型值。
```js
var s = new WeakSet();
var x = { id: 1 }, y = { id: 2 };
s.add(x);
s.add(y);

x = null;  // x 可 GC
y = null;  // y 可 GC
```

## 参考链接
- 《你不知道的JavaScript》(下)
- [MDN: Map](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map)
- [MDN: WeakMap](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap)
- [MDN: Set](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set)
- [MDN: WeakSet](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakSet)